name: Delete Package on Feature Branch Deletion

on:
  delete:
    branches:
      - "**"

jobs:
  delete_package:
    runs-on: ubuntu-latest
    steps:
      - name: Github context
        run: echo "${{ toJson(github) }}"

      - name: Extract branch name
        id: branch_name
        run: echo "BRANCH=$(cat ${{ github.event_path }} | jq --raw-output '.ref')" >> $GITHUB_ENV

      - name: Delete package version associated with the deleted branch
        run: |
          ORGANIZATION="${{ github.repository_owner }}"
          PACKAGE_NAME="${{ github.event.repository.name }}"
          BRANCH_NAME="${{ env.BRANCH_NAME }}"
          VERSION_TAG_PATTERN=".*-${BRANCH_NAME}$"

          echo "Searching for package versions to delete for branch: $BRANCH_NAME"

          PACKAGE_VERSIONS=$(curl -X GET "https://api.github.com/orgs/$ORGANIZATION/packages/npm/$PACKAGE_NAME/versions" \
            -H "Authorization: bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            | jq -r --arg VERSION_TAG_PATTERN "$VERSION_TAG_PATTERN" '.[] | select(.name | endswith($VERSION_TAG_PATTERN)) | .id')

          if [ -z "$PACKAGE_VERSIONS" ]; then
              echo "No matching versions found for branch $BRANCH_NAME."
          else
              for VERSION_ID in $PACKAGE_VERSIONS; do
                  echo "Deleting package version ID: $VERSION_ID"
                  curl -X DELETE "https://api.github.com/orgs/$ORGANIZATION/packages/npm/$PACKAGE_NAME/versions/$VERSION_ID" \
                    -H "Authorization: bearer ${{ secrets.GITHUB_TOKEN }}" \
                    -H "Accept: application/vnd.github.v3+json"
              done
          fi
